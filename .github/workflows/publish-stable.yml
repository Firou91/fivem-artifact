name: Publish FiveM Artifact (Stable)

on:
  schedule:
    - cron: "37 2 * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Forcer la publication même si la version est identique"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  publish:
    name: Publish ${{ matrix.platform }} artifact (stable)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            api_platform: win32
            branch: stable-windows
          - platform: linux
            api_platform: linux
            branch: stable-linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          set -xeuo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip xz-utils git-lfs
          git lfs install --local

      - name: Fetch recommended artifact metadata
        id: meta
        run: |
          set -xeuo pipefail
          api="https://changelogs-live.fivem.net/api/changelog/versions/${{ matrix.api_platform }}/server"
          json=$(curl -fsSL "$api")
          recommended_url=$(printf '%s' "$json" | jq -r '.recommended_download')
          recommended_version=$(basename "$(dirname "$recommended_url")")
          if [ -z "$recommended_url" ] || [ "$recommended_url" = "null" ]; then
            echo "Failed to resolve recommended_download from API"
            exit 1
          fi
          echo "recommended_url=$recommended_url" >> "$GITHUB_OUTPUT"
          echo "recommended_version=$recommended_version" >> "$GITHUB_OUTPUT"

      - name: Determine if update is needed
        id: check
        run: |
          set -xeuo pipefail
          current_version=""
          target_branch="${{ matrix.branch }}"
          git fetch origin "$target_branch" || true
          if git show-ref --verify --quiet "refs/remotes/origin/${target_branch}"; then
            current_version=$(git show "origin/${target_branch}:artifact-version.txt" 2>/dev/null || true)
            current_version=$(printf '%s' "$current_version")
          fi
          echo "current_version=$current_version"
          echo "recommended_version=${{ steps.meta.outputs.recommended_version }}"
          force="${{ github.event.inputs.force }}"
          if [ "$force" = "true" ]; then
            echo "Force publication demandée."
            echo "update_needed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$current_version" = "${{ steps.meta.outputs.recommended_version }}" ]; then
            echo "Version déjà à jour."
            echo "update_needed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "update_needed=true" >> "$GITHUB_OUTPUT"

      - name: Download recommended artifact
        id: download
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          archive_base="/tmp/server-${{ matrix.platform }}"
          recommended_url="${{ steps.meta.outputs.recommended_url }}"
          case "$recommended_url" in
            *.zip)
              archive_path="${archive_base}.zip"
              ;;
            *.tar.xz|*.txz)
              archive_path="${archive_base}.tar.xz"
              ;;
            *.tar.gz|*.tgz)
              archive_path="${archive_base}.tar.gz"
              ;;
            *)
              echo "Unsupported archive format: $recommended_url"
              exit 1
              ;;
          esac
          echo "Downloading $recommended_url -> $archive_path"
          curl -fSL "$recommended_url" -o "$archive_path"
          echo "archive_path=$archive_path" >> "$GITHUB_OUTPUT"

      - name: Checkout target branch
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          target_branch="${{ matrix.branch }}"
          git fetch origin "$target_branch" || true
          if git show-ref --verify --quiet "refs/remotes/origin/${target_branch}"; then
            git checkout -B "$target_branch" "origin/$target_branch"
          else
            git checkout -B "$target_branch"
          fi

      - name: Configure LFS tracking
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          cat > .gitattributes <<'EOF'
          **/libnode*.so filter=lfs diff=lfs merge=lfs -text
          **/libnode*.dll filter=lfs diff=lfs merge=lfs -text
          EOF

      - name: Replace repository contents with artifact
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          echo "Cleaning repository (excluding .git and .github)..."
          shopt -s dotglob
          for entry in *; do
            case "$entry" in
              .git|.github|.gitattributes|.gitignore)
                continue
                ;;
            esac
            rm -rf "$entry"
          done
          echo "Extracting artifact..."
          archive="${{ steps.download.outputs.archive_path }}"
          case "$archive" in
            *.zip)
              unzip -oq "$archive"
              ;;
            *.tar.xz|*.txz)
              tar -xJf "$archive"
              ;;
            *.tar.gz|*.tgz)
              tar -xzf "$archive"
              ;;
            *)
              echo "Unsupported archive format: $archive"
              exit 1
              ;;
          esac
          echo "${{ steps.meta.outputs.recommended_version }}" > artifact-version.txt
          echo "Removing .gitignore files from extracted content..."
          find . -type f -name ".gitignore" \
            ! -path "./.gitignore" \
            ! -path "./.git/*" ! -path "./.github/*" \
            ! -path "./.git" ! -path "./.github" \
            -print -delete
          echo "Extraction complete."
          file_count=$(find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name '.' -print | wc -l)
          echo "Files/directories at repo root (excluding .git/.github): $file_count"
          if [ "$file_count" -eq 0 ]; then
            echo "No files extracted. Failing build."
            exit 1
          fi

      - name: Show workspace status
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          ls -la
          echo "---"
          git status -sb

      - name: Commit and push changes
        if: steps.check.outputs.update_needed == 'true'
        run: |
          set -xeuo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          if git diff --cached --quiet --ignore-submodules; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: publish fivem artifact (stable/${{ matrix.platform }}) ${{ steps.meta.outputs.recommended_version }}"
          git push origin "${{ matrix.branch }}"

      - name: Skip message
        if: steps.check.outputs.update_needed == 'false'
        run: |
          echo "Skip publishing: stable artifact already up-to-date for ${{ matrix.branch }}."
